#!/usr/bin/rc

. $PLAN9/bin/9.rc
. $PLAN9/lib/acme.rc

ftmp=`{mktemp /tmp/awww.XXXXXX}

fn event {
	# $1 - c1 origin of event
	# $2 - c2 type of action
	# $3 - q0 beginning of selection
	# $4 - q1 end of selection
	# $5 - eq0 beginning of expanded selection
	# $6 - eq1 end of expanded selection
	# $7 - flag
	# $8 - nr number of runes in $9
	# $9 - text
	# $10 - chorded argument
	# $11 - origin of chorded argument

	switch($1$2){
	case E*	# write to body or tag
	case F*	# generated by ourselves; ignore
	case K*	# type away we do not care
	case Mi	# mouse: text inserted in tag
	case MI	# mouse: text inserted in body
	case Md	# mouse: text deleted from tag
	case MD	# mouse: text deleted from body

	case Mx MX	# button 2 in tag or body
		{
			if(~ $9 http://*) wwwwin $9
			if not {
				if(~ $9 https://*) wwwwin $9
				if not  winwriteevent $*
			}
		} &

	case Ml ML	# button 3 in tag or body
		{
			wwwwin $9
		} &
	}
}

fn wwwwin {
	newwindow
	winname $1
	if(test -f $1) html2text $1 | winwrite body
	if not {
		# -nv not verbose.
		# -k convert links to absolute URL.
		# --no-check-certificate ignore https certificate.
		# >[2]/dev/null, redirect error output to /dev/null
 		wget -nv -k --no-check-certificate $1 -O $ftmp >[2]/dev/null && html2text $ftmp | winwrite body 
		rm -rf $ftmp
	}
	#go to top
	echo dot=addr | 9p write acme/$winid/ctl
	echo show | 9p write acme/$winid/ctl

	winctl clean
	wineventloop
}

switch($#*){
case 0
	newwindow
	winname awww usage
	echo 'usage: awww [URL]' | winwrite body
	winctl clean
case *
	for(i)
		wwwwin $i
}
